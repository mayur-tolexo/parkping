<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Scan Vehicle QR</title>
  <link rel="stylesheet" href="/static/css/app.css">
  <script src="https://unpkg.com/html5-qrcode"></script>
</head>
<body>
<div class="container">
  <h1>Scan Vehicle QR</h1>
  <div id="reader" style="width:100%; height:300px;"></div>
  <p id="message"></p>
  <button id="retry" class="hidden">Retry Scan</button>
</div>

<script>
  const message = document.getElementById("message");
  const retryBtn = document.getElementById("retry");

  // Start scanner function
  function startScanner() {
    message.innerText = "Initializing camera...";
    retryBtn.classList.add("hidden");

    const html5QrcodeScanner = new Html5Qrcode("reader");

    html5QrcodeScanner.start(
            { facingMode: "environment" }, // use back camera
            { fps: 10, qrbox: 250 },       // scan options
            qrCodeMessage => {
              // QR detected
              html5QrcodeScanner.stop().then(() => {
                message.innerText = `FASTag detected: ${qrCodeMessage}`;
                handleScan(qrCodeMessage);
              });
            },
            errorMessage => {
              // ignore scan errors
            }
    ).catch(err => {
      message.innerText = "Camera access denied or not supported";
      retryBtn.classList.remove("hidden");
      console.error(err);
    });
  }

  // Handle scan result
  function handleScan(fastag) {
    const token = localStorage.getItem("token");
    if (!token) {
      alert("Please login first");
      return;
    }

    fetch(`/api/v1/vehicle/lookup?fastag=${fastag}`, {
      headers: { "Authorization": "Bearer " + token }
    })
            .then(res => {
              if (!res.ok) throw new Error("Vehicle not found");
              return res.json();
            })
            .then(data => {
              localStorage.setItem("vehicleData", JSON.stringify(data));
              window.location.href = "/profile.html";
            })
            .catch(err => {
              message.innerText = err.message;
              retryBtn.classList.remove("hidden");
            });
  }

  // Retry scan
  retryBtn.addEventListener("click", () => {
    startScanner();
    message.innerText = "";
  });

  startScanner();
</script>
</body>
</html>
